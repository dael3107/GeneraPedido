<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ReadyPlex | Genera tu pedido</title>

<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>

<style>
  /* ========= Base (claro fijo) ========= */
  :root{
    --primary:#1f3fff;
    --primary-pressed:#162dcc;
    --primary-soft:#eef2ff;
    --accent:#22c55e;
    --danger:#ef4444;
    --text:#0f172a;
    --muted:#64748b;
    --bg:#ffffff;
    --page:#f6f7fb;
    --line:#e5e7eb;
    --radius:16px;
    --shadow-sm:0 4px 12px rgba(2,6,23,.06);
    --shadow-md:0 10px 24px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--page);color:var(--text);font-family:"Libre Baskerville", serif}
  .page{max-width:1100px;margin:24px auto;padding:16px}
  .card{background:var(--bg);border-radius:var(--radius);box-shadow:var(--shadow-md);padding:24px;border:1px solid var(--line)}
  .header{display:block;margin-bottom:8px}

  .header-top{display:grid;grid-template-columns: 220px 1fr 280px;align-items:center;gap:16px;}
  .logo-box{width:220px;height:120px;background:#fff;border-radius:14px;overflow:hidden;border:1px solid var(--line)}
  .logo{width:100%;height:100%;object-fit:fill;display:block}

  .titlebox{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;text-align:center}
  h1{margin:0;font-size:clamp(24px,4.2vw,38px);font-weight:700;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:15px}

  .client{display:flex;flex-direction:column;gap:10px;}
  .client select,.client input{
    padding:12px 14px;border:1.5px solid var(--line);border-radius:12px;font-size:14px;background:#f8fafc;
    transition:border-color .15s,box-shadow .15s,background .15s;
  }
  .client input[readonly]{background:#eef2ff;color:#1f2937}
  .client select:focus,.client input:focus{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.14);background:#fff;}

  .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:18px}
  .search{flex:1;min-width:240px;padding:10px 14px;border:1.5px solid var(--line);border-radius:12px;background:#f8fafc}
  .search:focus{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.14)}

  /* ===== GRID portada ===== */
  #catalogSection{margin-top:12px}
  .featured-title{margin:20px 0 14px;font-size:24px;font-weight:700;text-align:center;color:#0b0b0c} /* negro */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}
  .grid-card{position:relative;background:#fff;border-radius:16px;box-shadow:var(--shadow-sm);padding:10px;border:1px solid var(--line);cursor:pointer;text-align:center;transition:transform .12s, box-shadow .15s}
  .grid-card:hover{transform:translateY(-2px);box-shadow:0 14px 32px rgba(2,6,23,.10)}
  .grid-card__img-wrap{width:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:12px;overflow:hidden;background:#fff}
  .grid-card img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .grid-card__name{margin-top:10px;font-weight:700}
  .badge{
    position:absolute; top:12px; left:12px; padding:6px 10px; font-size:11px; letter-spacing:.04em; font-weight:700;
    background:var(--primary); color:#fff; border-radius:999px; box-shadow:var(--shadow-sm)
  }

  /* ===== Tabla empresa ===== */
  .table-wrap{overflow:auto;margin-top:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{text-transform:uppercase;font-size:12px;letter-spacing:.08em;color:#475569;text-align:left;padding:0 14px;white-space:nowrap}
  tbody tr{background:#fff;box-shadow:var(--shadow-sm);border-radius:14px;border:1px solid var(--line);transition:transform .08s, box-shadow .15s}
  tbody tr:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(2,6,23,.10)}
  tbody td{padding:14px;vertical-align:middle}
  tbody tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  tbody tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}

  .name-btn{background:transparent;border:0;color:var(--primary);cursor:pointer;font-weight:700;padding:0;text-align:left;text-underline-offset:3px}
  .name-btn:hover{opacity:.9}
  .name-with-thumb{display:flex;align-items:center;gap:10px}
  .name-with-thumb .thumb{width:40px;height:52px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#fff}

  .code{font-weight:700;letter-spacing:.3px}
  .qty{width:80px;padding:6px 8px;border:1.5px solid var(--line);border-radius:12px;font-size:15px;outline:none;text-align:left;background:#fff;transition:border-color .15s,box-shadow .15s}
  .qty:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.14)}
  .unit{padding:10px 12px;border:1.5px solid var(--line);border-radius:12px;background:#fff;transition:border-color .15s,box-shadow .15s}
  .unit:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.14)}

  .select-btn{appearance:none;border:0;border-radius:999px;padding:10px 18px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--shadow-sm);transition:transform .06s, background .15s, filter .15s}
  .select-btn:hover{filter:brightness(1.05)}
  .select-btn:active{transform:translateY(1px);background:var(--primary-pressed)}
  .select-btn.selected{background:var(--accent)}
  .select-btn.selected::before{content:"✓ ";font-weight:700}

  .actions{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:18px;flex-wrap:wrap}
  .btn{min-width:180px;appearance:none;border:0;border-radius:999px;padding:12px 24px;background:#0f172a;color:#fff;font-weight:700;letter-spacing:.4px;cursor:pointer;box-shadow:var(--shadow-sm);transition:transform .06s, filter .15s}
  .btn:hover{filter:brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:var(--danger)}

  .pager{display:flex;gap:8px;align-items:center}
  .page-btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .page-btn[disabled]{opacity:.5;cursor:not-allowed}
  .page-info{color:var(--muted);font-size:14px}

  /* ===== Modal de imagen grande ===== */
  .image-modal{position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; z-index:100; padding:20px;}
  .image-modal-content{position:relative; background:var(--bg); border-radius:16px; padding:20px; max-width:90vw; max-height:90vh; display:flex; align-items:center; justify-content:center; box-shadow:0 25px 80px rgba(2,6,23,.35); border:1px solid var(--line)}
  .image-modal img{max-width:100%; max-height:80vh; object-fit:contain; display:block;}
  .image-modal-close{position:absolute; top:10px; right:14px; font-size:28px; font-weight:700; color:var(--text); cursor:pointer; background:none; border:none; line-height:1;}

  /* ===== Modal visor PDF ===== */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .modal-card{background:var(--bg);border-radius:16px;box-shadow:0 25px 80px rgba(2,6,23,.35);max-width:900px;width:100%;height:90vh;display:flex;flex-direction:column;border:1px solid var(--line)}
  .modal-header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .modal-actions{display:flex;gap:8px}
  .modal-btn{padding:8px 14px;border-radius:10px;border:1px solid var(--line);background:var(--bg);cursor:pointer}
  .modal-body{flex:1;overflow:auto}
  .pdf-frame{width:100%;height:100%;border:0}

  /* ===== Responsive ===== */
  @media (max-width:980px){
    .header-top{grid-template-columns:1fr; gap:12px;}
    .logo-box{margin:0 auto; display:flex; justify-content:center; align-items:center; height:auto;}
    .logo{max-width:180px; width:100%; height:auto; object-fit:contain}
    .btn{width:100%}
  }
  @media(max-width:820px){
    thead{display:none} 
    table,tbody,tr,td{display:block;width:100%}
    tbody tr{margin-bottom:12px} 
    tbody td{display:flex;justify-content:space-between;align-items:center}
    tbody td::before{content:attr(data-label);font-size:12px;color:var(--muted);
      text-transform:uppercase;letter-spacing:.08em;margin-right:10px}
    .actions{justify-content:stretch}
  }

  /* 🔴 Ocultar badge de unidad */
  .badge {
    display: none !important;
  }
</style>
</head>
<body>
  <main class="page">
    <section class="card">
      <div class="header">
        <div class="header-top">
          <div class="logo-box">
            <img id="logoRef" class="logo" src="imagenes/logo.jpg" alt="Logo ReadyPlex" />
          </div>

          <div class="titlebox">
            <h1>Genera tu pedido Rediplast</h1>
            <div class="sub">Selecciona los productos, indica cantidades y genera tu pedido.</div>
          </div>

          <div class="client">
            <select id="empresaSelect" aria-label="Empresa">
              <option value="">Selecciona empresa…</option>
            </select>
            <input id="ruc" type="text" inputmode="numeric" placeholder="RUC" readonly />
          </div>
        </div>

        <div class="toolbar" id="searchBar">
          <input id="search" class="search" type="search" placeholder="Buscar por nombre..." />
        </div>
      </div>

      <!-- ======= CATÁLOGO BASE (GRID) ======= -->
      <section id="catalogSection">
        <div id="featuredTitle" class="featured-title">Productos destacados</div>
        <div id="catalogGrid" class="grid"></div>
      </section>

      <!-- ======= LISTA POR EMPRESA (TABLA) ======= -->
      <section id="tableSection" style="display:none">
        <div class="table-wrap">
          <table id="tabla-productos" aria-describedby="Listado de productos">
            <thead>
              <tr>
                <th>Producto</th>
                <th>COD SAP</th>
                <th>Cantidad</th>
                <th>Magnitud</th>
                <th>Seleccionar</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="actions">
          <div class="pager">
            <button id="prev" class="page-btn">Anterior</button>
            <span id="pageInfo" class="page-info"></span>
            <button id="next" class="page-btn">Siguiente</button>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btnClear" class="btn secondary" type="button">Borrar todo</button>
            <button id="btnPDF" class="btn" type="button">Vista previa PDF y descargar PEDIDO</button>
            <button id="btnWhatsApp" class="btn" type="button" style="background:#25D366">Enviar por WhatsApp</button>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Modal imagen grande -->
  <div id="imageModal" class="image-modal">
    <div class="image-modal-content">
      <button class="image-modal-close" id="closeImageModal" aria-label="Cerrar previsualización">&times;</button>
      <img id="modalImage" src="" alt="Vista ampliada" />
    </div>
  </div>

  <!-- Modal visor PDF -->
  <div id="pdfModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <strong>Vista previa del PDF</strong>
        <div class="modal-actions">
          <button id="downloadPDF" class="modal-btn">Descargar</button>
          <button id="closePDF" class="modal-btn">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe id="pdfFrame" class="pdf-frame"></iframe>
      </div>
    </div>
  </div>

<script>
  /* ===================== Empresas ===================== */
  const COMPANIES = [
    { name: "PASTELERIA EL UNIVERSO EIRL", ruc: "20519059895" },
    { name: "SUPER GUSTO S.A.C.", ruc: "20608416545" },
    { name: "RESTOINVESTMENTS S.A.C", ruc: "20600431677" }
  ];

  const empresaSelect = document.getElementById('empresaSelect');
  const rucInput = document.getElementById('ruc');

  for (const c of COMPANIES) {
    const opt = document.createElement('option');
    opt.value = c.ruc;
    opt.textContent = c.name;
    empresaSelect.appendChild(opt);
  }

  empresaSelect.addEventListener('change', ()=>{
    const ruc = empresaSelect.value;
    const found = COMPANIES.find(c => c.ruc === ruc);
    rucInput.value = found ? found.ruc : "";

    if (ruc) { setCurrentCatalog(PRODUCTS_BY_COMPANY[ruc] || []); toggleViews('table'); }
    else { setCurrentCatalog([]); toggleViews('grid'); }
  });

  /* ===================== Catálogo base (con unidad para badge) ===================== */
  const PRODUCTS = [
    { name:"BOLSA ZIPLOC 2X2", img:"imagenes/2-2.png", unit:"MILLAR" },
    { name:"BOLSA ZIPLOC 3X3", img:"imagenes/3-3.png", unit:"MILLAR" },
    { name:"BOLSA ZIPLOC 3X4", img:"imagenes/3-4.png", unit:"MILLAR" },
    { name:"BOLSA ZIPLOC 3X5", img:"imagenes/3-5.png", unit:"MILLAR" },
    { name:"BOLSA ZIPLOC 3X6", img:"imagenes/3-6.png", unit:"MILLAR" },
    { name:"BOLSA DE DESECHOS", img:"imagenes/bolsa-basura.png", unit:"MILLAR" },
    { name:"LEJIA 4.8 LT", img:"imagenes/lejia.png", unit:"UNIDAD" },
    { name:"DETERGENTE 13.5 KG", img:"imagenes/detergente.png", unit:"UNIDAD" },
  ];
  const GRID_CATALOG = PRODUCTS;

  /* ===================== Catálogos por empresa ===================== */
  const PRODUCTS_BY_COMPANY = {
    "20519059895": [
      { name:"BOLSA ZIPLOC 2X2", code:"12345678910", unit:"MILLAR",  img:"imagenes/2X2.png" },
      { name:"BOLSA ZIPLOC 3X3", code:"12345678911", unit:"MILLAR",  img:"imagenes/3X3.png" },
      { name:"BOLSA ZIPLOC 3X4", code:"12345678912", unit:"MILLAR",  img:"imagenes/3X4.png" },
      { name:"BOLSA ZIPLOC 3X5", code:"12345678913", unit:"CIENTO",  img:"imagenes/3X5.png" },
      { name:"BOLSA ZIPLOC 3X6", code:"12345678914", unit:"MILLAR",  img:"imagenes/3X6.png" },
      { name:"BOLSA DE DESECHO 25 LT", code:"12345678915", unit:"MILLAR",  img:"imagenes/bolsa-basura.png" },
      { name:"LEJIA 4.8 LT", code:"12345678916", unit:"UNIDAD",  img:"imagenes/lejia-solo.png" },
      { name:"DETERGENTE DE 13.5 KG", code:"12345678917", unit:"UNIDAD",  img:"imagenes/detergente-1.png" }
    ],
    "20608416545": [
      { name:"BOLSA DE DESECHO 25 LT", code:"12345678915", unit:"MILLAR",  img:"imagenes/bolsa-basura.png" },
      { name:"LEJIA 4.8 LT", code:"12345678916", unit:"UNIDAD",  img:"imagenes/lejia-solo.png" },
      { name:"DETERGENTE DE 13.5 KG", code:"12345678917", unit:"UNIDAD",  img:"imagenes/detergente-1.png" },
      { name:"BOLSA ZIPLOC 2X2", code:"12345678910", unit:"MILLAR",  img:"imagenes/2X2.png" },
      { name:"BOLSA ZIPLOC 3X3", code:"12345678911", unit:"MILLAR",  img:"imagenes/3X3.png" },
      { name:"BOLSA ZIPLOC 3X4", code:"12345678912", unit:"MILLAR",  img:"imagenes/3X4.png" },
      { name:"BOLSA DE DESECHO 35 LT", code:"12345678918", unit:"MILLAR",  img:"imagenes/bolsa-basura.png" }
    ],
    "20600431677": [
      { name:"LEJIA 4.8 LT", code:"12345678916", unit:"UNIDAD",  img:"imagenes/lejia-solo.png" },
      { name:"DETERGENTE DE 13.5 KG", code:"12345678917", unit:"UNIDAD",  img:"imagenes/detergente-1.png" },
      { name:"BOLSA DE DESECHO 25 LT", code:"12345678915", unit:"MILLAR",  img:"imagenes/bolsa-basura.png" },
      { name:"BOLSA DE DESECHO 35 LT", code:"12345678918", unit:"MILLAR",  img:"imagenes/bolsa-basura.png" },
      { name:"BOLSA ZIPLOC 3X5", code:"12345678913", unit:"CIENTO",  img:"imagenes/3X5.png" },
      { name:"BOLSA ZIPLOC 3X6", code:"12345678914", unit:"MILLAR",  img:"imagenes/3X6.png" }
    ],
    default: PRODUCTS
  };

  /* ===================== GRID inicial ===================== */
  const catalogGrid = document.getElementById('catalogGrid');
  function renderGrid(list = GRID_CATALOG) {
    catalogGrid.innerHTML = '';
    list.forEach(p => {
      const card = document.createElement('button');
      card.className = 'grid-card';
      card.innerHTML = `
        <div class="grid-card__img-wrap">
          <img src="${p.img}" alt="${p.name}" />
        </div>
        ${p.unit ? `<span class="badge">${p.unit}</span>` : ``}
        <div class="grid-card__name">${p.name}</div>
      `;
      card.addEventListener('click', ()=> showImageModal(p.img));
      catalogGrid.appendChild(card);
    });
  }

  /* ===================== Tabla por empresa ===================== */
  const tableSection = document.getElementById('tableSection');
  const catalogSection = document.getElementById('catalogSection');
  const searchBar = document.getElementById('searchBar');
  const featuredTitle = document.getElementById('featuredTitle');

  const tbody = document.getElementById('tbody');
  const pageInfo = document.getElementById('pageInfo');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const searchInput = document.getElementById('search');

  const PAGE_SIZE = 10;
  let state = { q:"", page:1 };
  let CURRENT_PRODUCTS = [];
  let ORDER_STATE = new Map();

  function setCurrentCatalog(products) {
    CURRENT_PRODUCTS = Array.isArray(products) ? products.slice() : [];
    ORDER_STATE = new Map();
    for (const p of CURRENT_PRODUCTS) ORDER_STATE.set(p.code, { selected:false, qty:"", unit:p.unit });
    state.page = 1;
    renderTable();
  }

  function getFiltered(){
    const q = state.q.trim().toLowerCase();
    if(!q) return CURRENT_PRODUCTS;
    return CURRENT_PRODUCTS.filter(p => p.name.toLowerCase().includes(q));
  }
  function getPaged(){
    const list = getFiltered();
    const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
    if(state.page > totalPages) state.page = totalPages;
    const start = (state.page - 1) * PAGE_SIZE;
    return { items: list.slice(start, start + PAGE_SIZE), total: list.length, totalPages };
  }

  function renderTable(){
    tbody.innerHTML = "";
    const { items, total, totalPages } = getPaged();
    items.forEach(p=>{
      const st=ORDER_STATE.get(p.code)||{selected:false,qty:"",unit:p.unit};
      const tr=document.createElement('tr');
      tr.dataset.product=p.name; tr.dataset.code=p.code; tr.dataset.img=p.img;
      tr.innerHTML=`
        <td data-label="Producto">
          <button class="name-btn name-with-thumb" type="button" title="Ver imagen">
            <img class="thumb" src="${p.img}" alt="">
            <span>${p.name}</span>
          </button>
        </td>
        <td class="code" data-label="COD SAP">${p.code}</td>
        <td data-label="Cantidad"><input class="qty" type="text" inputmode="numeric" placeholder="0" value="${st.qty!==""?st.qty:""}" /></td>
        <td data-label="Magnitud">
          <select class="unit">
            <option value="UNIDADES"${st.unit==="UNIDADES"?" selected":""}>UNIDADES</option>
            <option value="CIENTO"${st.unit==="CIENTO"?" selected":""}>CIENTO</option>
            <option value="MILLAR"${st.unit==="MILLAR"?" selected":""}>MILLAR</option>
            <option value="LITRO"${st.unit==="LITRO"?" selected":""}>LITRO</option>
          </select>
        </td>
        <td data-label="Seleccionar"><button class="select-btn ${st.selected ? "selected" : ""}" type="button">${st.selected ? "SELECCIONADO" : "PEDIDO"}</button></td>
      `;
      tbody.appendChild(tr);
    });
    pageInfo.textContent=`Página ${state.page} de ${totalPages} · ${total} producto(s)`;
    prevBtn.disabled = state.page <= 1;
    nextBtn.disabled = state.page >= totalPages;
  }

  // Delegación eventos tabla
  tbody.addEventListener("click",(e)=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const code=tr.dataset.code; const st=ORDER_STATE.get(code);
    if(e.target.classList.contains("select-btn")){
      const btn=e.target; const sel=!btn.classList.contains("selected");
      btn.classList.toggle("selected",sel); btn.textContent=sel?"SELECCIONADO":"PEDIDO";
      st.selected=sel; ORDER_STATE.set(code,st);
    }
    if(e.target.closest(".name-with-thumb")){
      showImageModal(tr.dataset.img);
    }
  });
  tbody.addEventListener("input",(e)=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const code=tr.dataset.code; const st=ORDER_STATE.get(code);
    if(e.target.classList.contains("qty")){
      e.target.value=e.target.value.replace(/[^\d]/g,'');
      st.qty=e.target.value; ORDER_STATE.set(code,st);
    }
  });
  tbody.addEventListener("change",(e)=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const code=tr.dataset.code; const st=ORDER_STATE.get(code);
    if(e.target.classList.contains("unit")){
      st.unit=e.target.value; ORDER_STATE.set(code,st);
    }
  });

  // Buscar
  searchInput.addEventListener('input', (e)=>{
    state.q = e.target.value;
    state.page = 1;
    renderTable();
  });

  prevBtn?.addEventListener('click',()=>{ state.page=Math.max(1,state.page-1); renderTable(); });
  nextBtn?.addEventListener('click',()=>{ state.page=state.page+1; renderTable(); });

  // Borrar todo (volver a portada)
  document.getElementById('btnClear').addEventListener('click', ()=>{
    for (const p of CURRENT_PRODUCTS) {
      const st = ORDER_STATE.get(p.code);
      ORDER_STATE.set(p.code, { selected:false, qty:"0", unit: st ? st.unit : p.unit });
    }
    empresaSelect.selectedIndex = 0;
    rucInput.value = "";
    state = { q:"", page:1 };
    setCurrentCatalog([]);
    renderGrid();
    toggleViews('grid');
  });

  // Inicial
  renderGrid();
  toggleViews('grid');

  function toggleViews(which){
    if (which === 'grid') {
      catalogSection.style.display = '';
      featuredTitle.style.display = '';
      tableSection.style.display = 'none';
      searchBar.style.display = 'none';
    } else {
      catalogSection.style.display = 'none';
      featuredTitle.style.display = 'none';
      tableSection.style.display = '';
      searchBar.style.display = '';
    }
  }

  /* ===================== Modal de imagen ===================== */
  const imageModal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");
  const closeImageModal = document.getElementById("closeImageModal");

  function showImageModal(imgSrc){
    modalImage.src = imgSrc;
    imageModal.style.display = "flex";
  }
  closeImageModal.addEventListener("click", ()=>{
    imageModal.style.display = "none";
    modalImage.src = "";
  });
  imageModal.addEventListener("click", (e)=>{
    if(e.target === imageModal){
      imageModal.style.display = "none";
      modalImage.src = "";
    }
  });

  /* ===================== PDF ===================== */
  async function buildPDFBlob(){
    const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert("No se pudo cargar jsPDF."); return null; }

    const seleccionados = CURRENT_PRODUCTS.map(p=>{
      const st=ORDER_STATE.get(p.code); if(!st||!st.selected) return null;
      const qty=st.qty===""?0:parseInt(st.qty,10); if(!Number.isFinite(qty) || qty<0) return null;
      return { nombre:p.name, code:p.code, qty, unit:st.unit };
    }).filter(Boolean);

    if(seleccionados.length===0){ alert("Selecciona al menos un producto y coloca una cantidad."); return null; }

    const doc=new jsPDF({unit:'pt',format:'a4'}); const pageW=doc.internal.pageSize.getWidth();
    doc.setFont('times','bold'); doc.setFontSize(16); doc.text('Pedido - Rediplast',40,40);
    doc.setFont('times','normal'); doc.setFontSize(10); const fecha=new Date().toLocaleString(); doc.text(`Fecha: ${fecha}`,40,56);

    const empresaName=empresaSelect.options[empresaSelect.selectedIndex]?.text||""; const ruc=rucInput.value||"";
    if(empresaSelect.value) doc.text(`Empresa: ${empresaName}`, pageW-40,40,{align:'right'});
    if(ruc) doc.text(`RUC: ${ruc}`, pageW-40,56,{align:'right'});

    const head=[["Producto","SAP COD","Cantidad","Magnitud"]];
    const body=seleccionados.map(s=>[s.nombre,s.code,String(s.qty),s.unit]);
    doc.autoTable({ head, body, startY:80, styles:{halign:'left',cellPadding:6,fontSize:10}, headStyles:{fillColor:[26,57,255],textColor:255}, columnStyles:{2:{halign:'center'}} });
    return doc.output('blob');
  }

  /* ===================== WhatsApp & PDF Preview ===================== */
  const WHATSAPP_NUMBER = "0";

  document.getElementById("btnWhatsApp").addEventListener("click", async () => {
    const blob = await buildPDFBlob();
    if (!blob) return;

    const fileName = `pedido-rediplast-${Date.now()}.pdf`;
    const file = new File([blob], fileName, { type: "application/pdf" });

    const empresaName = empresaSelect.options[empresaSelect.selectedIndex]?.text || "";
    const ruc = rucInput.value || "";
    let mensaje = "Hola, adjunto mi pedido en PDF.";
    if (empresaName) mensaje += `\nEmpresa: ${empresaName}`;
    if (ruc) mensaje += `\nRUC: ${ruc}`;

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try { await navigator.share({ files: [file], title: "Pedido - Rediplast", text: mensaje }); return; } catch {}
    }

    const waUrl = WHATSAPP_NUMBER
      ? `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`
      : `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    window.open(waUrl, "_blank");

    try {
      const blobUrl = URL.createObjectURL(blob);
      const pdfFrame = document.getElementById("pdfFrame");
      const modal = document.getElementById("pdfModal");
      pdfFrame.src = blobUrl;
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");
    } catch {}
  });

  const modal=document.getElementById('pdfModal');
  const pdfFrame=document.getElementById('pdfFrame');
  const closeBtn=document.getElementById('closePDF');
  const downloadBtn=document.getElementById('downloadPDF');
  let currentBlobUrl=null;

  document.getElementById("btnPDF").addEventListener("click", async ()=>{
    const blob=await buildPDFBlob(); if(!blob) return;
    if(currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
    currentBlobUrl=URL.createObjectURL(blob);
    pdfFrame.src=currentBlobUrl; modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  });
  closeBtn.addEventListener('click',()=>{
    modal.style.display='none'; modal.setAttribute('aria-hidden','true');
    if(currentBlobUrl){URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; pdfFrame.src='';}
  });
  downloadBtn.addEventListener('click',()=>{
    if(!currentBlobUrl) return;
    const a=document.createElement('a'); a.href=currentBlobUrl; a.download=`pedido-rediplast-${Date.now()}.pdf`; a.click();
  });

  // Arranque
  renderGrid();
  toggleViews('grid');
</script>
</body>
</html>
