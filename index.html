<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ReadyPlex | Genera tu pedido</title>

<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>

<style>
  :root{--primary:#1a39ff;--primary-pressed:#0f26b9;--selected:#12b981;--text:#111827;--muted:#6b7280;--bg:#fff;--shadow:0 10px 25px rgba(0,0,0,.08);--radius:18px;--celeste:#eaf0ff}
  *{box-sizing:border-box}
  html,body{margin:0;background:#f6f7fb;color:var(--text);font-family:"Libre Baskerville", serif}
  .page{max-width:1100px;margin:24px auto;padding:16px}
  .card{background:var(--bg);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
  .header{display:block;margin-bottom:8px}

  .header-top{display:grid;grid-template-columns: 220px 1fr 280px;align-items:center;gap:16px;}
  .logo-box{width:220px;height:120px;background:var(--celeste);border-radius:14px;overflow:hidden}
  .logo{
    width:100%;
    height:100%;
    object-fit:fill;   /* Estira la imagen para llenar el recuadro */
    display:block;
  }

  .titlebox{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;text-align:center}
  h1{margin:0;font-size:clamp(22px,4.5vw,36px);font-weight:700}
  .sub{color:var(--muted);font-size:15px}

  .client{display:flex;flex-direction:column;gap:10px;}
  .client select,.client input{padding:12px 14px;border:1.5px solid #e5e7eb;border-radius:12px;font-size:14px;background:#f3f6ff}
  .client input[readonly]{background:#eef2ff;color:#1f2937}

  .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:14px}
  .search{flex:1;min-width:240px;padding:10px 14px;border:1.5px solid #e5e7eb;border-radius:12px;font-size:15px}

  .table-wrap{overflow:auto;margin-top:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 12px}
  thead th{text-transform:uppercase;font-size:12px;letter-spacing:.08em;color:var(--muted);text-align:left;padding:0 14px;white-space:nowrap}
  tbody tr{background:#fff;box-shadow:var(--shadow);border-radius:14px}
  tbody td{padding:14px;vertical-align:middle}

  .name-btn{background:transparent;border:0;color:#0b57d0;cursor:pointer;font-weight:700;padding:0;text-align:left}
  .name-btn:focus{outline:2px solid #c7d2fe;border-radius:6px}
  .code{font-weight:700;letter-spacing:.3px}

  .qty{width:2cm;padding:6px 8px;border:1.5px solid #e5e7eb;border-radius:12px;font-size:15px;outline:none;text-align:left}
  .qty:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
  .unit{padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:12px;background:#fff}
  .select-btn{appearance:none;border:0;border-radius:999px;padding:10px 18px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:transform .06s,background .15s}
  .select-btn:active{transform:translateY(1px);background:var(--primary-pressed)}
  .select-btn.selected{background:var(--selected)}

  .actions{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:18px;flex-wrap:wrap}
  .btn{min-width:180px;appearance:none;border:0;border-radius:999px;padding:12px 24px;background:#0b0b0c;color:#fff;font-weight:700;letter-spacing:.4px;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:#ef4444}

  .pager{display:flex;gap:8px;align-items:center}
  .page-btn{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
  .page-btn[disabled]{opacity:.5;cursor:not-allowed}
  .page-info{color:var(--muted);font-size:14px}

  /* Popover miniatura (160x220) */
  .popover{position:absolute;z-index:50;display:none;background:transparent}
  .popover .popcard{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.18);padding:8px}
  .popover .viewport{width:160px;height:220px;display:flex;align-items:center;justify-content:center}
  .popover img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}

  /* Modal visor PDF */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .modal-card{background:#fff;border-radius:16px;box-shadow:0 25px 80px rgba(0,0,0,.35);max-width:900px;width:100%;height:90vh;display:flex;flex-direction:column}
  .modal-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .modal-actions{display:flex;gap:8px}
  .modal-btn{padding:8px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
  .modal-body{flex:1;overflow:auto}
  .pdf-frame{width:100%;height:100%;border:0}

  @media(max-width:980px){
    .header-top{grid-template-columns: 1fr; gap:12px;}
    .client{flex-direction:row;flex-wrap:wrap}
    .client select,.client input{flex:1;min-width:200px}
    .btn{width:100%}
  }
  @media(max-width:820px){
    thead{display:none} table,tbody,tr,td{display:block;width:100%}
    tbody tr{margin-bottom:12px} tbody td{display:flex;justify-content:space-between;align-items:center}
    tbody td::before{content:attr(data-label);font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-right:10px}
    .actions{justify-content:stretch}
  }
</style>
</head>
<body>
  <main class="page">
    <section class="card">
      <div class="header">
        <div class="header-top">
          <div class="logo-box">
            <img id="logoRef" class="logo" src="imagenes/logo.jpg" alt="Logo ReadyPlex" />
          </div>
          <div class="titlebox">
            <h1>Genera tu pedido Rediplast</h1>
            <div class="sub">Selecciona los productos, indica cantidades y genera tu pedido.</div>
          </div>
          <div class="client">
            <select id="empresaSelect" aria-label="Empresa">
              <option value="">Selecciona empresa…</option>
            </select>
            <input id="ruc" type="text" inputmode="numeric" placeholder="RUC" readonly />
          </div>
        </div>
        <div class="toolbar">
          <input id="search" class="search" type="search" placeholder="Buscar por nombre..." />
        </div>
      </div>

      <div class="table-wrap">
        <table id="tabla-productos" aria-describedby="Listado de productos">
          <thead>
            <tr>
              <th>Producto</th>
              <th>COD SAP</th>
              <th>Cantidad</th>
              <th>Magnitud</th>
              <th>Seleccionar</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="actions">
        <div class="pager">
          <button id="prev" class="page-btn">Anterior</button>
          <span id="pageInfo" class="page-info"></span>
          <button id="next" class="page-btn">Siguiente</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnClear" class="btn secondary" type="button">Borrar todo</button>
          <button id="btnPDF" class="btn" type="button">Vista previa PDF</button>
          <!-- NUEVO: Enviar por WhatsApp -->
          <button id="btnWhatsApp" class="btn" type="button" style="background:#25D366">Enviar por WhatsApp</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Popover miniatura -->
  <div id="imgPopover" class="popover" role="dialog" aria-hidden="true">
    <div class="popcard">
      <div class="viewport">
        <img alt="Vista producto" />
      </div>
    </div>
  </div>

  <!-- Modal visor PDF -->
  <div id="pdfModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <strong>Vista previa del PDF</strong>
        <div class="modal-actions">
          <button id="downloadPDF" class="modal-btn">Descargar</button>
          <button id="closePDF" class="modal-btn">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe id="pdfFrame" class="pdf-frame"></iframe>
      </div>
    </div>
  </div>

<script>
  /* Empresas */
  const COMPANIES = [
    { name: "PASTELERIA UNIVERSO", ruc: "1010256986" },
    { name: "SUPERMERCADO ALFA S.A.", ruc: "20512345678" },
    { name: "BODEGA LA ESQUINA", ruc: "10456789012" }
  ];
  const empresaSelect = document.getElementById('empresaSelect');
  const rucInput = document.getElementById('ruc');
  for (const c of COMPANIES) {
    const opt = document.createElement('option');
    opt.value = c.ruc; opt.textContent = c.name; empresaSelect.appendChild(opt);
  }
  empresaSelect.addEventListener('change', ()=>{
    const sel = empresaSelect.value;
    const found = COMPANIES.find(c => c.ruc === sel);
    rucInput.value = found ? found.ruc : "";
  });

  /* Productos (rutas locales en /imagenes) */
  const PRODUCTS = [
    { name:"ZIPLOC 2X2", code:"12345678910", unit:"UNIDADES", img:"imagenes/2X2.png" },
    { name:"ZIPLOC 3X3", code:"12345678911", unit:"CIENTO",  img:"imagenes/3X3.png" },
    { name:"ZIPLOC 3X4", code:"12345678912", unit:"MILLAR",  img:"imagenes/3X4.png" },
    { name:"ZIPLOC 3X5", code:"12345678913", unit:"CIENTO",  img:"imagenes/3X5.png" },
    { name:"ZIPLOC 3X6", code:"12345678914", unit:"MILLAR",  img:"imagenes/3X6.png" }
  ];

  /* Búsqueda + paginación */
  const PAGE_SIZE = 10;
  let state = { q:"", page:1 };
  const ORDER_STATE = new Map();
  for (const p of PRODUCTS) ORDER_STATE.set(p.code, { selected:false, qty:"", unit:p.unit });

  const tbody = document.getElementById('tbody');
  const pageInfo = document.getElementById('pageInfo');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');

  function getFiltered(){const q=state.q.trim().toLowerCase();return q?PRODUCTS.filter(p=>p.name.toLowerCase().includes(q)):PRODUCTS;}
  function getPaged(){const list=getFiltered();const totalPages=Math.max(1,Math.ceil(list.length/PAGE_SIZE));if(state.page>totalPages)state.page=totalPages;const start=(state.page-1)*PAGE_SIZE;return{items:list.slice(start,start+PAGE_SIZE),total:list.length,totalPages};}

  function render(){
    const { items, total, totalPages } = getPaged();
    tbody.innerHTML = "";
    items.forEach(p=>{
      const st=ORDER_STATE.get(p.code)||{selected:false,qty:"",unit:p.unit};
      const tr=document.createElement('tr');
      tr.dataset.product=p.name; tr.dataset.code=p.code; tr.dataset.img=p.img;
      tr.innerHTML=`
        <td data-label="Producto"><button class="name-btn" type="button">${p.name}</button></td>
        <td class="code" data-label="COD SAP">${p.code}</td>
        <td data-label="Cantidad"><input class="qty" type="text" inputmode="numeric" placeholder="0" value="${st.qty!==""?st.qty:""}" /></td>
        <td data-label="Magnitud">
          <select class="unit">
            <option value="UNIDADES"${st.unit==="UNIDADES"?" selected":""}>UNIDADES</option>
            <option value="CIENTO"${st.unit==="CIENTO"?" selected":""}>CIENTO</option>
            <option value="MILLAR"${st.unit==="MILLAR"?" selected":""}>MILLAR</option>
            <option value="LITRO"${st.unit==="LITRO"?" selected":""}>LITRO</option>
          </select>
        </td>
        <td data-label="Seleccionar"><button class="select-btn ${st.selected ? "selected" : ""}" type="button">${st.selected ? "SELECCIONADO" : "PEDIDO"}</button></td>
      `;
      tbody.appendChild(tr);
    });
    pageInfo.textContent=`Página ${state.page} de ${totalPages} · ${total} producto(s)`;
    prevBtn.disabled=state.page<=1; nextBtn.disabled=state.page>=totalPages;
  }

  tbody.addEventListener("click",(e)=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const code=tr.dataset.code; const st=ORDER_STATE.get(code);
    if(e.target.classList.contains("select-btn")){
      const btn=e.target; const sel=!btn.classList.contains("selected");
      btn.classList.toggle("selected",sel); btn.textContent=sel?"SELECCIONADO":"PEDIDO"; st.selected=sel; ORDER_STATE.set(code,st);
    }
    if(e.target.classList.contains("name-btn")) showPopoverFor(tr,e.target);
  });
  tbody.addEventListener("input",(e)=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const code=tr.dataset.code; const st=ORDER_STATE.get(code);
    if(e.target.classList.contains("qty")){ e.target.value=e.target.value.replace(/[^\d]/g,''); st.qty=e.target.value; ORDER_STATE.set(code,st); }
  });
  tbody.addEventListener("change",(e)=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const code=tr.dataset.code; const st=ORDER_STATE.get(code);
    if(e.target.classList.contains("unit")){ st.unit=e.target.value; ORDER_STATE.set(code,st); }
  });

  document.getElementById('search').addEventListener('input',(e)=>{state.q=e.target.value; state.page=1; render();});
  prevBtn.addEventListener('click',()=>{state.page=Math.max(1,state.page-1); render();});
  nextBtn.addEventListener('click',()=>{state.page=state.page+1; render();});

  document.getElementById('btnClear').addEventListener('click',()=>{
    for(const p of PRODUCTS){const st=ORDER_STATE.get(p.code); ORDER_STATE.set(p.code,{selected:false,qty:"0",unit:st?st.unit:p.unit});}
    empresaSelect.selectedIndex=0; rucInput.value=""; render();
  });

  render();

  /* Popover */
  const pop=document.getElementById("imgPopover");
  const popImg=pop.querySelector("img");
  function showPopoverFor(tr, anchorEl){
    popImg.src = tr.dataset.img;
    const rect=anchorEl.getBoundingClientRect();
    const top=window.scrollY+rect.bottom+10;
    const left=Math.max(16, Math.min(window.scrollX+rect.left, window.scrollX+window.innerWidth-200));
    pop.style.top=top+"px"; pop.style.left=left+"px";
    pop.style.display="block"; pop.setAttribute("aria-hidden","false");
  }
  document.addEventListener("click",(e)=>{
      if(!pop.contains(e.target) && !e.target.classList.contains("name-btn")){
        pop.style.display="none"; pop.setAttribute("aria-hidden","true");
      }
  });

  /* PDF (vista previa, sin imágenes) */
  async function buildPDFBlob(){
    const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert("No se pudo cargar jsPDF."); return null; }
    const seleccionados = PRODUCTS.map(p=>{
      const st=ORDER_STATE.get(p.code); if(!st||!st.selected) return null;
      const qty=st.qty===""?0:parseInt(st.qty,10); if(!Number.isFinite(qty) || qty<0) return null;
      return { nombre:p.name, code:p.code, qty, unit:st.unit };
    }).filter(Boolean);
    if(seleccionados.length===0){ alert("Selecciona al menos un producto y coloca una cantidad."); return null; }
    const doc=new jsPDF({unit:'pt',format:'a4'}); const pageW=doc.internal.pageSize.getWidth();
    doc.setFont('times','bold'); doc.setFontSize(16); doc.text('Pedido - Rediplast',40,40);
    doc.setFont('times','normal'); doc.setFontSize(10); const fecha=new Date().toLocaleString(); doc.text(`Fecha: ${fecha}`,40,56);
    const empresaName=empresaSelect.options[empresaSelect.selectedIndex]?.text||""; const ruc=rucInput.value||"";
    if(empresaSelect.value) doc.text(`Empresa: ${empresaName}`, pageW-40,40,{align:'right'});
    if(ruc) doc.text(`RUC: ${ruc}`, pageW-40,56,{align:'right'});
    const head=[["Producto","SAP COD","Cantidad","Magnitud"]]; const body=seleccionados.map(s=>[s.nombre,s.code,String(s.qty),s.unit]);
    doc.autoTable({ head, body, startY:80, styles:{halign:'left',cellPadding:6,fontSize:10}, headStyles:{fillColor:[26,57,255],textColor:255}, columnStyles:{2:{halign:'center'}} });
    return doc.output('blob');
  }

  /* ====== Enviar por WhatsApp ====== */
  // Si quieres fijar un número, ponlo aquí: "51xxxxxxxxx"; si lo dejas "", abre selector de contacto
  const WHATSAPP_NUMBER = "930714244";

  document.getElementById("btnWhatsApp").addEventListener("click", async () => {
    // Generar el PDF
    const blob = await buildPDFBlob();
    if (!blob) return;

    const fileName = `pedido-rediplast-${Date.now()}.pdf`;
    const file = new File([blob], fileName, { type: "application/pdf" });

    // Empresa y RUC para el mensaje
    const empresaName = empresaSelect.options[empresaSelect.selectedIndex]?.text || "";
    const ruc = rucInput.value || "";
    let mensaje = "Hola, adjunto mi pedido en PDF.";
    if (empresaName) mensaje += `\nEmpresa: ${empresaName}`;
    if (ruc) mensaje += `\nRUC: ${ruc}`;

    // 1) Intento: Web Share API (móvil)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: "Pedido - Rediplast",
          text: mensaje
        });
        return;
      } catch (err) {
        console.warn("Share cancelado o no disponible:", err);
      }
    }

    // 2) Fallback (escritorio): abrir WhatsApp Web con texto y mostrar la vista previa para descargar el PDF
    const waUrl = WHATSAPP_NUMBER
      ? `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`
      : `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    window.open(waUrl, "_blank");

    // Abrir tu modal de vista previa para descargar el PDF y adjuntarlo manualmente
    try {
      const blobUrl = URL.createObjectURL(blob);
      const pdfFrame = document.getElementById("pdfFrame");
      const modal = document.getElementById("pdfModal");
      pdfFrame.src = blobUrl;
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");
    } catch (e) {
      console.warn("No se pudo abrir la vista previa del PDF:", e);
    }
  });

  /* Modal PDF acciones */
  const modal=document.getElementById('pdfModal');
  const pdfFrame=document.getElementById('pdfFrame');
  const closeBtn=document.getElementById('closePDF');
  const downloadBtn=document.getElementById('downloadPDF');
  let currentBlobUrl=null;

  document.getElementById("btnPDF").addEventListener("click", async ()=>{
    const blob=await buildPDFBlob(); if(!blob) return;
    if(currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
    currentBlobUrl=URL.createObjectURL(blob); pdfFrame.src=currentBlobUrl; modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  });
  closeBtn.addEventListener('click',()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); if(currentBlobUrl){URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; pdfFrame.src='';}});
  downloadBtn.addEventListener('click',()=>{ if(!currentBlobUrl) return; const a=document.createElement('a'); a.href=currentBlobUrl; a.download=`pedido-rediplast-${Date.now()}.pdf`; a.click();});
</script>
</body>
</html>


